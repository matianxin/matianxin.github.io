---
title: 实验室虚拟化主站厂站拓扑搭建
tags: [kedong]
categories: Kedong
description: 实训平台-主站厂站虚拟化环境搭建
date: 2019/6/25 9:30:00
---

![](/images/virt_labo.jpg)

### 虚拟化正向隔离

#### ①创建虚拟化正向隔离组件 SW_1，开机
#### ②创建虚拟交换机 Switch_2，开机
#### ③创建虚拟交换机 Switch_3，开机
#### ④创建虚拟主机[win7-2-ok]-主站PC PC_4，开机
#### ⑤创建虚拟主机[win7-2-ok]-安全三区PC PC_5，开机
#### ⑥创建虚拟主机[win7-2-ok]-隔离SW_1管理工具 PC_6，开机
#### ⑦配置PC_4IP地址：192.168.1.10 255.255.255.0 192.168.1.1
#### ⑧配置PC_5IP地址：192.168.1.20 255.255.255.0 192.168.1.1
#### ⑨配置Switch_2：1-4口配置VLAN1001
#### ⑩配置Switch_3：1-4口配置VLAN1002
#### ⑪创建串口线，连接SW_1串口（内）与PC_6
#### ⑫创建网线，连接SW_1网卡0（内）与Switch_2网口1
#### ⑬创建网线，连接SW_1网卡0（外）与Switch_3网口1
#### ⑭创建网线，连接PC_4网卡0与Switch_2网口2
#### ⑮创建网线，连接PC_5网卡0与Switch_3网口2
#### ⑯配置正向隔离管理工具PC_6：

**配置管理工具。**
- PC_6右键 -> 上传/下载 -> 传入vc_redist.2015.x64与全QT界面隔离管理工具中包含vcruntime140.dll，libcrypto-1_1.dll。 -> 关闭
- 安装vc_redist.2015.x64
- 打开全QT界面隔离管理工具Stonewall.exe
- 屏幕分辨率 -> 1024×768
- 用户名：admin 密码：111111
- 串口登录。 串口：COM1。 频率：115200。 权限：管理员。 √ 正向隔离。

**设备配置 -> 基本配置**
- 管理IP：     无     -> 不填
- 设备名称：   zsw     -> 自定义
- 点击写入

**规则配置 -> 主机信息1 -> 添加**
- SW_1 -> 进入内网隔离系统 -> 清除主机信息与连接信息 -> 删除/etc/mac.conf 和 /etc/rules

- √ IP和MAC地址绑定
- 主机名：   PC_4            -> 自定义
- MAC1：    FA:16:3E:40:11:01 -> 主机网卡MAC地址
- 主机IP：   192.168.1.10      -> 主机网卡ip地址
- 主机虚拟IP1：192.168.1.11     -> ETH0协商IP与主机同网段时自动生成,不通网段时填写一个ETH0所在网段下任意IP地址
- 主机虚拟ip2：可以不填

**规则配置 -> 主机信息2 -> 添加**
- √ IP和MAC地址绑定
- 主机名：   PC_5          -> 自定义
- MAC1：    FA:16:3E:40:11:02 -> 主机网卡MAC地址
- 主机IP：   192.168.1.20      -> 主机网卡ip地址
- 主机虚拟IP1：192.168.1.21     -> ETH0协商IP与主机同网段时自动生成,不通网段时填写一个ETH0所在网段下任意IP地址
- 主机虚拟ip2：可以不填

**规则配置 -> 连接信息**
- 规则名：       rule         -> 自定义
- (内网)IP地址： 192.100.1.10
- (内网)虚拟IP： 192.100.1.11
- (内网)网口号： ETH0/网口0
- (外网)IP地址： 192.100.1.20
- (外网)虚拟IP： 192.100.1.21
- (外网)网口号： ETH0/网口0
- 协议：        TCP

#### ⑰配置后查看SW_1 /etc/mac.conf和/etc/rules是否与配置相同。重启SW_1内网隔离与外网隔离。

- 正向隔离： 发送端为内网 接收端为外网
- sender：PC_4 receiver：PC_5

#### ⑱配置及启动正向隔离外网接收端工具。

- PC_5 -> 进入系统 -> 右键 -> Terminal -> 以管理员身份运行 -> 进入目录 -> D:\software\隔离传输软件\正向\receive

- 以jar包方式运行 java -jar StoneWall-send.jar

#### ⑲配置及启动正向隔离内网发送端工具。

- PC_4 -> 进入系统 -> 右键 -> Terminal -> 以管理员身份运行 -> 进入目录 -> D:\software\隔离传输软件\send

- 以jar包方式运行 java -jar StoneWall-send.jar

- 待发送的文件（任何类型）-> 右键 -> 发送
 - 任务名称：   task        √ 主任务
 - 目的IP地址： 192.168.1.21 -> 接收端虚拟IP地址
 - 目的端口号： 7777
 - 目的文件夹： d:/test      -> 自定义
 - √ 立即发送
 - 查看日志及接收端是否发送成功。

### 虚拟化反向隔离

#### ⑳创建虚拟化反向隔离组件 SW_2，开机
#### ㉑创建虚拟主机[win7-2-ok]-隔离SW_2管理工具 PC_7，开机
#### ㉒创建串口线，连接SW_2串口（外）与PC_7
#### ㉓创建网线，连接SW_2网卡0（内）与Switch_2网口3
#### ㉔创建网线，连接SW_2网卡0（外）与Switch_3网口3
#### ㉕⑯配置反向隔离管理工具PC_7：

**配置管理工具。**
- PC_7右键 -> 上传/下载 -> 传入vc_redist.2015.x64与全QT界面隔离管理工具中包含vcruntime140.dll，libcrypto-1_1.dll。 -> 关闭
- 安装vc_redist.2015.x64
- 打开全QT界面隔离管理工具Stonewall.exe
- 屏幕分辨率 -> 1024×768
- 用户名：admin 密码：111111
- 串口登录。 串口：COM1。 频率：115200。 权限：管理员。 √ 反向隔离。

**设备配置 -> 基本配置**
- 管理IP：     无     -> 不填
- 设备名称：   fsw     -> 自定义
- ETH0协商IP： 192.168.1.200  -> 与发送端须配置成相同网段
- ETH1协商IP： 0.0.0.0        -> 可不做配置

**规则配置 -> 主机信息1 -> 添加**
- SW_2 -> 进入外网隔离系统 -> 清除主机信息与连接信息 -> 删除/etc/mac.conf 和 /etc/rules
- √ IP和MAC地址绑定
- 主机名：   PC_5          -> 自定义
- MAC1：    FA:16:3E:40:11:02 -> 主机网卡MAC地址
- 主机IP：   192.168.1.20      -> 主机网卡ip地址
- 主机虚拟IP1：192.168.1.22     -> ETH0协商IP与主机同网段时自动生成,不通网段时填写一个ETH0所在网段下任意IP地址
- 主机虚拟ip2：可以不填

**规则配置 -> 主机信息2 -> 添加**
- √ IP和MAC地址绑定
- 主机名：   PC_4            -> 自定义
- MAC1：    FA:16:3E:40:11:01 -> 主机网卡MAC地址
- 主机IP：   192.168.1.10      -> 主机网卡ip地址
- 主机虚拟IP1：192.168.1.12     -> ETH0协商IP与主机同网段时自动生成,不通网段时填写一个ETH0所在网段下任意IP地址
- 主机虚拟ip2：可以不填

**规则配置 -> 连接信息**
- 规则名：       rule         -> 自定义
- (内网)IP地址： 192.100.1.10
- (内网)虚拟IP： 192.100.1.12
- (内网)网口号： ETH0/网口0
- (外网)IP地址： 192.100.1.20
- (外网)虚拟IP： 192.100.1.22
- (外网)网口号： ETH0/网口0
- 协议：        UDP

**证书秘钥 -> 设备秘钥**
- 设备密钥 √ RSA -> 导出设备证书文件 -> fsw.cer
- 上传/下载 -> fsw.cer导出到本地

#### ㉖配置及启动反向隔离内网接收端工具。

- 上传/下载 -> 新的隔离接收端工具new_udp_recv_4.2.2.jar -> 复制到目录D:\software\隔离传输软件\反向\receive\下
- 右键 -> Terminal -> 以管理员身份运行 -> 进入目录 -> D:\software\隔离传输软件\反向\receive

- 以jar包方式运行 java -jar new_udp_recv_4.2.2.jar

#### ㉗配置及启动反向隔离外网发送端工具。
- 上传/下载 -> 新的隔离接收端工具new_udp_send_4.2.2.jar -> 复制到目录D:\software\隔离传输软件\反向\send\下
- 上传/下载 -> 反向隔离端证书 fsw.cer

- 检查config目录下是否有**.p12文件，若存在，则删除。
- 启动传输软件。 new_udp_recv_4.2.2.jar
- 右键 -> 以管理员身份运行 -> 命令行 -> 进入目录 -> D:\software\隔离传输软件\反向\send
```java
java -jar new_udp_recv_4.2.2.jar
设置密码口令保护窗口如果报错，需先运行jreUpdate1.8.jar
```
- 出现提示：系统检测到密钥尚未存在，是否需要生成密钥？ -> 是
- 创建登录口令：123456。 确定，提示操作成功。
- 登录窗口：
 - 操作员名称： administrator
 - 操作员密码： 12345678
 - 密钥保护口令： 123456
-
- 管理 -> 密钥管理 -> 导出密钥。 -> sender.cer

- 上传/下载 -> 反向隔离发送端证书 sender.cer

- 设定 -> 配置加密隧道
 - 隧道名称： Tunnel-1
 - 隧道的协商IP地址： 192.168.1.200  -> 设备ETH0协商IP
 - 隧道的协商端口：   4558
 - 隧道每次通过的文件数： 100
 - 隔离设备证书路径： ../.. fsw.cer
- 设定 -> 配置链路信息
 - 链路名称： Link-1
 - 目的IP地址： 192.168.1.12  -> 接收端IP地址，正反向隔离在相同环境的情况下，配置虚拟IP。
 - 目的端口：   7777
 - 发送失败等待周期(秒)： 30
 - 使用隧道：   Tunnel-1

#### ㉘PC_7导入发送端证书。
- 发送端证书 -> 删除其他
- 发送端证书 -> 添加
 - 发送端IP： 192.168.1.20 -> 此处为发送端IP，不为虚拟IP
 - 证书标识： sender.cer

#### ㉙重启SW_2内网隔离与外网隔离。

#### ㉚PC_5发送E文本。
- 待发送的文件（E文本）-> 右键 -> 发送
 - 任务名称：   task1
 - 目的文件夹： d:/test      -> 自定义
 - 选择链路 -> Link-1 -> 添加
 - 不符合发送条件的文件备份至 -> 当前文档目录
 - 查看日志及接收端是否发送成功。
 - 如果发现隔离发送进行中一直在校验E文本规范，不发送的情况，重新打开发送端工具。

### 虚拟化纵向

#### ㉛创建虚拟化纵向[电力纵向]PS_1，开机
#### ㉜创建虚拟化纵向[电力纵向]PS_2，开机
#### ㉝创建虚拟路由器R，配置：网卡1：192.168.1.0/24 网卡2：192.168.2.0/24，开机
#### ㉞创建虚拟交换机 Switch_1，开机
#### ㉟创建虚拟主机[win7-2]PC_3，开机
#### ㊱创建虚拟主机[win7-2]PC_2，开机
#### ㊲创建虚拟主机[win7-2]PC_1，开机
#### ㊳创建虚拟USB-KEY UK_1，插入PS_1
#### ㊴创建虚拟USB-KEY UK_2，插入PS_2
#### ㊵配置Switch_1：1-2口配置VLAN1003
#### ㊶配置PC_3IP地址：169.254.200.201 255.255.255.0 169.254.200.1
#### ㊷配置PC_2IP地址：169.254.200.201 255.255.255.0 169.254.200.1
#### ㊸配置PC_1IP地址：192.168.2.20 255.255.255.0 192.168.2.1
#### ㊹创建网线，连接PS_1网口0与Switch_2网口4
#### ㊺创建网线，连接PS_1网口1与R网口1
#### ㊻创建网线，连接PS_2网口1与R网口2
#### ㊼创建网线，连接PS_2网口0与Switch_1网口1
#### ㊽创建网线，连接PC_1网卡0与Switch_1网口2
#### ㊾创建网线，连接PC_2网卡0与PS_2网卡4
#### ㊿创建网线，连接PC_3网卡0与PS_1网卡4
#### (51)PC_3本地安装及配置纵向PS_1：
安装纵向管理工具：
- 目录地址：d:/software/PSTunnel2000加密装置千兆管理工具.exe
添加新操作员：
- 右键 -> 以管理员身份运行 -> 操作员 -> 操作员管理 -> 添加：+操作员： user -> 确定
导出导入证书：
- 初始化 -> 生成设备密钥及证书请求 -> 下一步 -> 填写省/市/设备名 -> 下一步 -> 生成.csr证书
- 证书转换。使用证书工具2.0将.csr证书转换为.cer证书。传入对端。
- 证书 -> 证书导入 -> 远程设备证书 -> 选择证书 -> 确定
VLAN配置：
- 本地ETH1：192.168.1.50 255.255.255.0 VLAN：0
- 远程ETH1：192.168.2.50 255.255.255.0 VLAN：0
路由配置：
- 目的地址：192.168.2.50
- 子网掩码：255.255.255.0
- 网关地址：192.168.1.1
安全隧道:
- -> 恢复隧道配置 -> 11.pbak -> 配置写入装置 -> 确定 -> 修改隧道 -> 确定
 - 隧道名标识： 11 -> 不支持修改
 - 本地IP： 192.168.1.50 -> 本地ETH1
 - 远程IP： 192.168.2.50 -> 远程ETH1
 -          255.255.255.0
 -          0.0.0.0
 -          0.0.0.0
 - MTU：    1500
安全策略：
- -> 恢复策略配置 -> 11.pbak -> 配置写入装置 -> 确定 -> 修改策略 -> 确定
 - 标识id：0
 - 本地IP： 192.168.1.50 -> 本地ETH1
 - 远程IP： 192.168.2.50 -> 远程ETH1
 - 本地起始IP：192.168.1.1
 - 本地终止IP：192.168.1.254
 - 远程起始IP：192.168.2.1
 - 远程终止IP：192.168.2.254
 - 方向：双向

重置隧道：
- -> 管理 -> 重置隧道 -> OPENED

注意：
- *新纵向的用户名,密码：root, Tun-2000
- 纵向内部查询路由命令：
```bash
$ monipead.arm -all
```

#### (52)PC_2本地安装及配置纵向PS_2：
配置与以上相同，反向。

#### (53)PC_4配置静态路由：
```php
route add -p 192.168.2.0 mask 255.255.255.0 192.168.1.1
```

#### (54)PC_1配置静态路由：
```php
route add -p 192.168.1.0 mask 255.255.255.0 192.168.2.1
```
#### (55)验证纵向的功能：
使用PC_4 ping PC_1
```php
ping 192.168.2.50
```
查看PS_2的eth1口是否抓到ESP报文包。
